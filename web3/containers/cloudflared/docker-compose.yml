services:
  cloudflared:
    image: cloudflare/cloudflared:latest@sha256:404528c1cd63c3eb882c257ae524919e4376115e6fe57befca8d603656a91a4c
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_METRICS=localhost:60123
    env_file:
      - .env
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "--metrics", "localhost:60123", "ready"]
      start_period: 10s
      interval: 30s
      retries: 3
      timeout: 10s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    networks:
      - cloudflared-gw
      - app-infra

networks:
  cloudflared-gw:
    driver: bridge
  app-infra:
    external: true
