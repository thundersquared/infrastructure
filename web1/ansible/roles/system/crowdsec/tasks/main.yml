- name: Read CrowdSec token from environment
  set_fact:
    crowdsec_token: "{{ lookup('env', 'CROWDSEC_TOKEN') | default('', true) }}"

- name: Download CrowdSec GPG key
  get_url:
    url: https://packagecloud.io/crowdsec/crowdsec/gpgkey
    dest: /usr/share/keyrings/crowdsec.asc
    mode: '0644'

- name: Add CrowdSec repository
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/crowdsec.asc] https://packagecloud.io/crowdsec/crowdsec/ubuntu/ {{ ansible_distribution_release }} main
    state: present
    filename: crowdsec
  register: crowdsec_repo

- name: Update apt cache
  apt:
    update_cache: yes
  when: crowdsec_repo.changed

- name: Install CrowdSec
  apt:
    name: crowdsec
    state: present

- name: Install CrowdSec iptables firewall bouncer
  apt:
    name: crowdsec-firewall-bouncer-iptables
    state: present

- name: Install CrowdSec nginx bouncer
  apt:
    name: crowdsec-nginx-bouncer
    state: present

- name: Deploy CrowdSec configuration
  template:
    src: config.yaml.j2
    dest: /etc/crowdsec/config.yaml
  notify: restart crowdsec

- name: Enable and start CrowdSec service
  service:
    name: crowdsec
    enabled: yes
    state: started

- name: Enable and start CrowdSec firewall bouncer service
  service:
    name: crowdsec-firewall-bouncer
    enabled: yes
    state: started

- name: Check CrowdSec console enrollment status
  command: cscli console status -o json
  register: console_status
  changed_when: false

- name: Enroll CrowdSec with console
  command: cscli console enroll "{{ crowdsec_token }}"
  when: crowdsec_token | length > 0 and 'console_management' not in (console_status.stdout | from_json)