- name: Set CrowdSec token
  set_fact:
    crowdsec_token: "{{ lookup('env', 'CROWDSEC_TOKEN') }}"

- name: Download CrowdSec GPG key
  get_url:
    url: https://packagecloud.io/crowdsec/crowdsec/gpgkey
    dest: /usr/share/keyrings/crowdsec.asc
    mode: '0644'

- name: Add CrowdSec repository
  apt_repository:
    repo: deb [signed-by=/usr/share/keyrings/crowdsec.asc] https://packagecloud.io/crowdsec/crowdsec/ubuntu/ {{ ansible_distribution_release }} main
    state: present
    filename: crowdsec
  register: crowdsec_repo

- name: Update apt cache
  apt:
    update_cache: yes
  when: crowdsec_repo.changed

- name: Install CrowdSec
  apt:
    name: crowdsec
    state: present

- name: Install CrowdSec iptables firewall bouncer
  apt:
    name: crowdsec-firewall-bouncer-iptables
    state: present

- name: Install CrowdSec nginx bouncer
  apt:
    name: crowdsec-nginx-bouncer
    state: present

- name: Enable and start CrowdSec service
  service:
    name: crowdsec
    enabled: yes
    state: started

- name: Enable and start CrowdSec firewall bouncer service
  service:
    name: crowdsec-firewall-bouncer
    enabled: yes
    state: started

- name: Check CrowdSec console enrollment status
  command: cscli console status
  register: console_status
  failed_when: false
  when: crowdsec_token is defined and crowdsec_token != ''

- name: Enroll CrowdSec with console
  command: cscli console enroll "{{ crowdsec_token }}"
  when: crowdsec_token is defined and crowdsec_token != '' and console_status is defined and console_status.rc != 0