---
# Migration: 20260204_0003_fix_crowdsec_nftables_priority
# Description: Switch CrowdSec firewall bouncer from iptables to nftables mode
# Problem: mode: iptables causes CrowdSec to use iptables even when nftables config exists
# Solution: Change mode to nftables to use the nftables configuration block

- name: Check if CrowdSec firewall bouncer config exists
  stat:
    path: /etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml
  register: bouncer_config

- name: Update CrowdSec firewall bouncer mode to nftables
  lineinfile:
    path: /etc/crowdsec/bouncers/crowdsec-firewall-bouncer.yaml
    regexp: '^mode:'
    line: 'mode: nftables'
  when: bouncer_config.stat.exists

- name: Restart CrowdSec firewall bouncer to apply new config
  service:
    name: crowdsec-firewall-bouncer
    state: restarted
  when: bouncer_config.stat.exists
